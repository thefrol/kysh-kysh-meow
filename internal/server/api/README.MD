# API

## Обноваление 10.1

Кажется у нас тут образовался какой-то прото-контроллер для хранилища. Он как бы получает `metrica.Metrica` на вход и выход. А хендлеры могут так или иначе оборачивать этот метод как им удобно. Или использовать напрямую.

достаточно посмотреть как работает `MarshallUnmarshallMetrica()` из `apiv2` и `UnwrapURLParams()` из `apiv1`. В своей сердцевине они имеют по сути одну логику, просто оборачивают её разными представлениями. Идя дальше по этой ветке, мы получаем, что `apiv1` это просто метод обертка как бы, **один метод, а не класс**. И все. И больше ничего не надо. Вот к чему хочется придти:

```go
r.Get("/value/{type}/{name}/{value}", TextWrapper(controller.Update))
r.POST("/update/{type}/{name}/{value}", TextWrapper(controller.Get))

r.POST("/value", JSONWrapper(controller.Get))
r.POST("/update", JSONWrapper(controller.Update))

r.POST("/batch", BatchWrapper(controller.Update))
```

Я даже думаю по сути нам нужен один метод. Который умеет обновлять и забирать значения изз хранилища кучей.

```go
type Controller interface{
    Get(req []Metrica) (resp []Metrica, error)
    Update(req []Metrica) (out []Metrica, error)
}
```

Возможно это даже методы тупо хранилища. Меня немного пугает использовать Metrica в хранилище потому что это ну, тупо транспортная тема. Возможно нам стоит сделать аналог, но для слоя хранения.

### Что нужено добавить в хранилище

Мне кажется с учетом БД, теперь хранилище должно проверять себя на здоровье. Это мы будем использовать в методе Ping. Возможно этим может заниматься контроллер. А ещё кажется, у него должен быть метод `Flush()`, который использяет все транзации после из запроса.

Скорее всего метод `Check/Ping` будет именно у контроллера. А не у store. Таким образом store становится ну совсем уже какой-то далекой фигней. Не понимаю

Это правда приводит к странным обстоятельствам. Например, `UpdateCounter()`, теперь должен возвращать какое-то значение, которое будет изменено вдальнейшем при завершеннии транзации. То есть возвращать ссылку. Короче, очень странно. Возможно БД будет сразу `контроллером`